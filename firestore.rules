rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to validate required fields
    function isValidCode(data) {
      return data.keys().hasAll(['code', 'createdAt']) &&
             data.code is string &&
             data.code.size() > 0 &&
             data.createdAt is string;
    }
    
    function isValidCourse(data) {
      return data.keys().hasAll(['title', 'description', 'instructor', 'duration', 'createdAt']) &&
             data.title is string &&
             data.description is string &&
             data.instructor is string &&
             data.duration is string &&
             data.createdAt is string &&
             data.lessonsCount is int &&
             // التأكد من وجود adminCode
             data.adminCode is string &&
             data.adminCode.size() > 0;
    }
    
    function isValidVideo(data) {
      return data.keys().hasAll(['courseId', 'title', 'url', 'createdAt']) &&
             data.courseId is string &&
             data.title is string &&
             data.url is string &&
             data.createdAt is string &&
             // التأكد من وجود adminCode
             data.adminCode is string &&
             data.adminCode.size() > 0;
    }
    
    function isValidTest(data) {
      return data.keys().hasAll(['title', 'description', 'adminCode', 'createdAt']) &&
             data.title is string &&
             data.title.size() > 0 &&
             data.description is string &&
             data.description.size() > 0 &&
             data.adminCode is string &&
             data.adminCode.size() > 0 &&
             data.createdAt is string &&
             data.questionsCount is int &&
             data.questionsCount >= 0;
    }
    
    function isValidQuestion(data) {
      return data.keys().hasAll(['testId', 'options', 'correctAnswerIndex', 'order']) &&
             data.testId is string &&
             data.testId.size() > 0 &&
             // يجب أن يكون هناك نص سؤال أو صورة
             ((data.questionText is string && data.questionText.size() > 0) ||
              (data.imageUrl is string && data.imageUrl.size() > 0)) &&
             data.options is list &&
             data.options.size() >= 2 &&
             data.correctAnswerIndex is int &&
             data.correctAnswerIndex >= 0 &&
             data.correctAnswerIndex < data.options.size() &&
             data.order is int &&
             data.order >= 0;
    }
    
    function isValidTestResult(data) {
      return data.keys().hasAll(['testId', 'studentCode', 'totalQuestions', 'correctAnswers', 'wrongAnswers', 'score', 'completedAt', 'answers']) &&
             data.testId is string &&
             data.testId.size() > 0 &&
             data.studentCode is string &&
             data.studentCode.size() > 0 &&
             data.totalQuestions is int &&
             data.totalQuestions > 0 &&
             data.correctAnswers is int &&
             data.correctAnswers >= 0 &&
             data.wrongAnswers is int &&
             data.wrongAnswers >= 0 &&
             data.score is number &&
             data.score >= 0 &&
             data.score <= 100 &&
             data.completedAt is string &&
             data.answers is map;
    }

    // ==================== Admin Codes Collection ====================
    match /adminCodes/{adminCodeId} {
      // القراءة للجميع (لأن التحقق من كود الأدمن يحدث قبل تسجيل الدخول)
      allow read: if true;
      
      // السماح بتحديث imageUrl فقط (لرفع صورة الأدمن)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['imageUrl']) &&
                       request.resource.data.imageUrl is string;
      
      // باقي عمليات الكتابة محظورة - فقط من Firebase Console
      allow create, delete: if false;
    }

    // ==================== Codes Collection ====================
    match /codes/{codeId} {
      // القراءة للجميع (لأن الكود يحتاج التحقق منه قبل تسجيل الدخول)
      allow read: if true;
      
      // الكتابة مقيدة - فقط من التطبيق (يمكن إضافة authentication لاحقاً)
      allow create: if isValidCode(request.resource.data) &&
                       // التأكد من وجود adminCode
                       request.resource.data.adminCode is string &&
                       request.resource.data.adminCode.size() > 0;
      allow update: if isValidCode(request.resource.data) &&
                       // التأكد من وجود adminCode
                       request.resource.data.adminCode is string &&
                       request.resource.data.adminCode.size() > 0;
      allow delete: if true; // يمكن تقييد الحذف لاحقاً
    }

    // ==================== Courses Collection ====================
    match /courses/{courseId} {
      // القراءة للجميع (المستخدمون يحتاجون رؤية الكورسات)
      allow read: if true;
      
      // الكتابة - فقط مع البيانات الصحيحة
      allow create: if isValidCourse(request.resource.data);
      allow update: if isValidCourse(request.resource.data) &&
                       // منع تغيير createdAt
                       request.resource.data.createdAt == resource.data.createdAt &&
                       // منع تغيير adminCode
                       request.resource.data.adminCode == resource.data.adminCode;
      allow delete: if true; // يمكن تقييد الحذف لاحقاً
    }

    // ==================== Videos Collection ====================
    match /videos/{videoId} {
      // القراءة للجميع (المستخدمون يحتاجون رؤية الفيديوهات)
      allow read: if true;
      
      // الكتابة - فقط مع البيانات الصحيحة
      allow create: if isValidVideo(request.resource.data) &&
                       // التأكد من وجود الكورس
                       exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId));
      allow update: if isValidVideo(request.resource.data) &&
                       // منع تغيير createdAt
                       request.resource.data.createdAt == resource.data.createdAt &&
                       // منع تغيير courseId
                       request.resource.data.courseId == resource.data.courseId &&
                       // منع تغيير adminCode
                       request.resource.data.adminCode == resource.data.adminCode;
      allow delete: if true; // يمكن تقييد الحذف لاحقاً
    }

    // ==================== Video Progress Collection ====================
    match /videoProgress/{progressId} {
      // القراءة للجميع (المستخدمون يحتاجون قراءة تقدمهم)
      allow read: if true;
      
      // الكتابة - السماح بإنشاء وتحديث وحذف تقدم الفيديوهات
      // التحقق من وجود الحقول المطلوبة
      allow create: if request.resource.data.keys().hasAll(['code', 'courseId', 'videoId', 'isWatched']) &&
                       request.resource.data.code is string &&
                       request.resource.data.courseId is string &&
                       request.resource.data.videoId is string &&
                       request.resource.data.isWatched is bool;
      
      allow update: if request.resource.data.keys().hasAll(['code', 'courseId', 'videoId', 'isWatched']) &&
                       request.resource.data.code is string &&
                       request.resource.data.courseId is string &&
                       request.resource.data.videoId is string &&
                       request.resource.data.isWatched is bool &&
                       // التأكد من عدم تغيير code و courseId و videoId
                       request.resource.data.code == resource.data.code &&
                       request.resource.data.courseId == resource.data.courseId &&
                       request.resource.data.videoId == resource.data.videoId;
      
      allow delete: if true; // السماح بالحذف (عند إلغاء حالة المشاهدة)
    }

    // ==================== Tests Collection ====================
    match /tests/{testId} {
      // القراءة للجميع (الطلاب يحتاجون رؤية الاختبارات)
      allow read: if true;
      
      // الكتابة - فقط مع البيانات الصحيحة
      allow create: if isValidTest(request.resource.data);
      
      allow update: if isValidTest(request.resource.data) &&
                       // منع تغيير createdAt
                       request.resource.data.createdAt == resource.data.createdAt &&
                       // منع تغيير adminCode
                       request.resource.data.adminCode == resource.data.adminCode;
      
      allow delete: if true; // يمكن تقييد الحذف لاحقاً
    }

    // ==================== Questions Collection ====================
    match /questions/{questionId} {
      // القراءة للجميع (الطلاب يحتاجون رؤية الأسئلة)
      allow read: if true;
      
      // الكتابة - فقط مع البيانات الصحيحة
      allow create: if isValidQuestion(request.resource.data) &&
                       // التأكد من وجود الاختبار
                       exists(/databases/$(database)/documents/tests/$(request.resource.data.testId));
      
      allow update: if isValidQuestion(request.resource.data) &&
                       // منع تغيير testId
                       request.resource.data.testId == resource.data.testId;
      
      allow delete: if true; // يمكن تقييد الحذف لاحقاً
    }

    // ==================== Test Results Collection ====================
    match /testResults/{resultId} {
      // القراءة للجميع (يمكن تقييدها لاحقاً للطالب نفسه فقط)
      allow read: if true;
      
      // الكتابة - فقط مع البيانات الصحيحة
      allow create: if isValidTestResult(request.resource.data) &&
                       // التأكد من وجود الاختبار
                       exists(/databases/$(database)/documents/tests/$(request.resource.data.testId));
      
      allow update: if isValidTestResult(request.resource.data) &&
                       // منع تغيير testId و studentCode
                       request.resource.data.testId == resource.data.testId &&
                       request.resource.data.studentCode == resource.data.studentCode &&
                       // منع تغيير completedAt
                       request.resource.data.completedAt == resource.data.completedAt;
      
      allow delete: if true; // يمكن تقييد الحذف لاحقاً
    }

    // ==================== Default Deny ====================
    // رفض أي شيء آخر
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
